pipeline {
    agent {
        kubernetes {
            label 'python'
            defaultContainer 'python'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    some-label: python
spec:
  containers:
  - name: python
    image: walkwayai/python:2.0
    command:
    - cat
    tty: true
"""
}
}
    parameters {
        string(name: 'product_id', defaultValue: '7249P9, 7845P10, 77354P1, 3763GATEWAY, 16168P1, 16168P10, 252750P2, 7812P106', description: 'List of IDs of the products (e.g. 7249P9, 7845P10, 77354P1, 3763GATEWAY, 16168P1, 16168P10, 252750P2, 7812P106)')
        choice(name: 'city_name', choices: ['same', 'any'], description: 'If same, only products from the same city are shown.')
        choice(name: 'supplier_code', choices: ['different', 'any'], description: 'If different, only products from other suppliers are shown.')
        choice(name: 'average_rating', choices: ['any', 'similar'], description: 'If similar, only products with similar average ratings are shown.')
        choice(name: 'start_year', choices: ['any', '2022', '2023', '2024'], description: 'Products older than this year will not be considered.')
        choice(name: 'landmarks', choices: ['any', 'same'], description: 'If same, only products mentioning the same landmark(s) will be shown. If there are no landmarks in the selected product, this filter will be ignored.')
        choice(name: 'is_private', choices: ['any', 'same'], description: 'If same, only products with the same tour type (private/public) will be shown.')
        choice(name: 'categories', choices: ['one', 'any', 'same'], description: 'If same, only products with the same sub-category will be shown. If there are no categories in the selected product, this filter will be ignored.')
        choice(name: 'embedding_fields', choices: ['Product Description, Product Title', 'Product Title, Incl/Excl Text, Tour Grade Description', 'Product Description, Incl/Excl Text', 'Product Description, Product Title, Incl/Excl Text, Tour Grade Description'], description: 'Fields for the embedding model.')
    }
    stages {
        stage('Experiment Results') {
            steps {
                container('python') {
                    script {
                        def customBuildNumber = params.product_id
                        currentBuild.displayName = "${customBuildNumber}"
                        withCredentials([string(credentialsId: 'OPENAI_API_KEY', variable: 'OPENAI_API_KEY')]) {
                            withCredentials([file(credentialsId: 'gcp_service_account_json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                                sh """
                                python3 src/experiment_product_similarity.py \
                                    -credentials ${GOOGLE_APPLICATION_CREDENTIALS} \
                                    -product_id '${params.product_id}' \
                                    -city_name ${params.city_name} \
                                    -supplier_code ${params.supplier_code} \
                                    -average_rating ${params.average_rating} \
                                    -start_year ${params.start_year} \
                                    -landmarks ${params.landmarks} \
                                    -is_private ${params.is_private} \
                                    -categories ${params.categories} \
                                    -embedding_fields '${params.embedding_fields}' \
                                    -apikey ${OPENAI_API_KEY} \
                                    -experiment_id ${customBuildNumber}
                                """
                            }
                        }
                    }
                }
            }
        }
    }
}