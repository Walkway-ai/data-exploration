pipeline {
    agent {
        kubernetes {
            label 'python'
            defaultContainer 'python'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    some-label: python
spec:
  containers:
  - name: python
    image: walkwayai/python:latest
    command:
    - cat
    tty: true
"""
        }
    }
    parameters {
        string(name: 'product_id', defaultValue: '6462P29', description: 'ID of the product (e.g. 104357P6, 6462P29, 16168P1, 47475P7, 3267P8)')
        choice(name: 'city_name', choices: ['same', 'any', 'different'], description: 'If same, only products from the same city are shown.')
        choice(name: 'supplier_code', choices: ['different', 'any', 'same'], description: 'If different, only products from other suppliers are shown.')
        choice(name: 'average_rating', choices: ['any', 'similar', 'different'], description: 'If similar, only products with similar average ratings are shown.')
        choice(name: 'tour_grade_code', choices: ['same', 'any', 'different'], description: 'If same, only products with same tour grade codes are shown.')
        choice(name: 'start_year', choices: ['2022', '2023', '2024', 'any'], description: 'Products older than this year will not be considered.')
        choice(name: 'embedding_model', choices: ['jina-embeddings-v2-base-en', 'mean', 'gte-large'], description: 'Embedding model.')
    }
    environment {
        LOG_FILE = 'experiment.log'
    }
    stages {
        stage('Experiment Results') {
            steps {
                container('python') {
                    script {
                        withCredentials([string(credentialsId: 'OPENAI_API_KEY', variable: 'OPENAI_API_KEY')]) {
                            sh """
                            python3 src/experiment_product_similarity.py \
                                -product_id ${params.product_id} \
                                -city_name ${params.city_name} \
                                -supplier_code ${params.supplier_code} \
                                -average_rating ${params.average_rating} \
                                -tour_grade_code ${params.tour_grade_code} \
                                -start_year ${params.start_year} \
                                -embedding_model ${params.embedding_model} \
                                -apikey ${OPENAI_API_KEY} | tee ${env.LOG_FILE}
                            """
                        }
                    }
                }
            }
        }
        stage('Write your feedback') {
            steps {
                script {
                    def feedbackMessage = """
                    Did the results show similar products to the original product?
                    Were results better with OpenAI?
                    """
                    def userFeedback = input message: feedbackMessage, parameters: [string(name: 'feedback', defaultValue: '', description: 'Your feedback')]
                    currentBuild.description = userFeedback
                }
            }
        }
        stage('Send Feedback') {
            steps {
                script {
                    def logs = readFile(env.LOG_FILE)
                    def emailBody = """
                        ${logs}

                        User Feedback:

                        ${currentBuild.description}
                    """
                    emailext(
                        attachLog: true, 
                        body: emailBody, 
                        subject: 'Experiment Feedback', 
                        to: 'fabio@walkway.ai'
                    )
                }
            }
        }
    }
}
