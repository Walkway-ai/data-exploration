pipeline {
    agent {
        kubernetes {
            label 'python'
            defaultContainer 'python'
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    some-label: python
spec:
  containers:
  - name: python
    image: walkwayai/python:2.0
    command:
    - cat
    tty: true
"""
}
}
    parameters {
        string(name: 'product_id', defaultValue: '10428P6,104357P6,129335P2,13405P16,143594P2,15081P466,16168P1,16168P10,2140P187,252750P2,15081P240,329999P26,3763GATEWAY,47475P7,5250LIBERTYELLIS,5716GOLFWINE,6462P29,7249P9,77354P1,7812P106,7812P126,7845P10,324527P1,9511P25', description: 'List of IDs of the products, separated by a comma.')
        choice(name: 'landmarks', choices: ['any', 'same'], description: 'If same, only products mentioning the same landmark(s) will be shown. If there are no landmarks in the selected product, this filter will be ignored.')
        choice(name: 'is_private', choices: ['any', 'same'], description: 'If same, only products with the same tour type (private/public) will be shown.')
        choice(name: 'categories', choices: ['one', 'any', 'same'], description: 'If same, only products with the same sub-category will be shown. If there are no categories in the selected product, this filter will be ignored.')
        choice(name: 'embedding_fields', choices: ['Product Description, Product Title', 'Product Title, Incl/Excl Text, Tour Grade Description', 'Product Description, Incl/Excl Text', 'Product Description, Product Title, Incl/Excl Text, Tour Grade Description'], description: 'Fields for the embedding model.')
    }
    stages {
        stage('Experiment Results') {
            steps {
                container('python') {
                    script {
                        def customBuildNumber = params.product_id
                        currentBuild.displayName = "${customBuildNumber}"
                        withCredentials([string(credentialsId: 'OPENAI_API_KEY', variable: 'OPENAI_API_KEY')]) {
                            withCredentials([file(credentialsId: 'gcp_service_account_json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                                sh """
                                python3 src/experiment_product_similarity.py \
                                    -credentials ${GOOGLE_APPLICATION_CREDENTIALS} \
                                    -product_id '${params.product_id}' \
                                    -city_name "same" \
                                    -supplier_code "different" \
                                    -average_rating "any" \
                                    -start_year "any" \
                                    -landmarks ${params.landmarks} \
                                    -is_private ${params.is_private} \
                                    -categories ${params.categories} \
                                    -embedding_fields '${params.embedding_fields}' \
                                    -apikey ${OPENAI_API_KEY} \
                                    -experiment_id ${customBuildNumber}
                                """
                            }
                        }
                    }
                }
            }
        }
    }
}